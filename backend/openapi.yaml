openapi: "3.0.3"
info:
  title: RentWide API
  version: "1.0.0"
  description: Demo real estate REST API for the RentWide platform (Kampala, Uganda)
servers:
  - url: http://localhost:3000/api
    description: Local development

paths:
  /health:
    get:
      summary: Health check
      tags: [System]
      responses:
        "200":
          description: App and DB are healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /listings:
    get:
      summary: List and filter listings
      tags: [Listings]
      parameters:
        - { name: q, in: query, schema: { type: string }, description: "Full-text search" }
        - { name: type, in: query, schema: { type: string, enum: [RENT, SALE] } }
        - { name: category, in: query, schema: { type: string, enum: [HOUSE, APARTMENT, OFFICE, LAND] } }
        - { name: minPrice, in: query, schema: { type: integer } }
        - { name: maxPrice, in: query, schema: { type: integer } }
        - { name: bedrooms, in: query, schema: { type: integer } }
        - { name: neighborhood, in: query, schema: { type: string }, description: "Neighborhood slug" }
        - { name: sort, in: query, schema: { type: string, enum: [price_asc, price_desc, newest, oldest] } }
        - { name: page, in: query, schema: { type: integer, default: 1 } }
        - { name: perPage, in: query, schema: { type: integer, default: 12 } }
      responses:
        "200":
          description: Paginated listing summaries
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListingsResponse"

  /listings/nearby:
    get:
      summary: Listings near a coordinate
      tags: [Listings]
      parameters:
        - { name: lat, in: query, required: true, schema: { type: number } }
        - { name: lng, in: query, required: true, schema: { type: number } }
        - { name: radius_km, in: query, schema: { type: number, default: 5 } }
      responses:
        "200":
          description: Nearby listing summaries
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListingsResponse"
        "400":
          $ref: "#/components/responses/ValidationError"

  /listings/{id}:
    get:
      summary: Get a single listing (by id or slug)
      tags: [Listings]
      parameters:
        - { name: id, in: path, required: true, schema: { type: string } }
      responses:
        "200":
          description: Full listing with images and agent
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListingDetailResponse"
        "404":
          $ref: "#/components/responses/NotFound"

  /neighborhoods:
    get:
      summary: List neighborhoods
      tags: [Neighborhoods]
      parameters:
        - { name: popular, in: query, schema: { type: boolean }, description: "Sort by listing count" }
      responses:
        "200":
          description: Array of neighborhoods with listing counts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NeighborhoodsResponse"

  /viewings:
    post:
      summary: Request a viewing
      tags: [Leads]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateViewingInput"
      responses:
        "201":
          description: Viewing created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "404":
          $ref: "#/components/responses/NotFound"

  /contacts:
    post:
      summary: Submit a contact lead
      tags: [Leads]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateContactInput"
      responses:
        "201":
          description: Contact created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessResponse"
        "400":
          $ref: "#/components/responses/ValidationError"

  /seed:
    post:
      summary: Seed the database (dev only)
      tags: [System]
      responses:
        "200":
          description: DB seeded
        "403":
          description: Forbidden in production

components:
  schemas:
    SuccessResponse:
      type: object
      properties:
        success: { type: boolean, example: true }
        data: { type: object }

    ErrorResponse:
      type: object
      properties:
        success: { type: boolean, example: false }
        error:
          type: object
          properties:
            code: { type: string }
            message: { type: string }
            details: { type: array, items: { type: object } }

    HealthResponse:
      allOf:
        - $ref: "#/components/schemas/SuccessResponse"
        - properties:
            data:
              type: object
              properties:
                status: { type: string, example: ok }
                db: { type: string, example: reachable }
                timestamp: { type: string, format: date-time }

    ListingSummary:
      type: object
      properties:
        id: { type: string }
        code: { type: string, example: RW-1001 }
        title: { type: string }
        price: { type: integer }
        priceFrequency: { type: string, enum: [MONTHLY, ONE_TIME] }
        bedrooms: { type: integer }
        neighborhood:
          type: object
          properties:
            name: { type: string }
            slug: { type: string }
        thumbUrl: { type: string, nullable: true }
        lat: { type: number }
        lng: { type: number }
        status: { type: string, enum: [AVAILABLE, UNDER_OFFER, SOLD] }

    ListingsResponse:
      type: object
      properties:
        success: { type: boolean }
        data:
          type: array
          items:
            $ref: "#/components/schemas/ListingSummary"
        meta:
          type: object
          properties:
            page: { type: integer }
            perPage: { type: integer }
            total: { type: integer }
            totalPages: { type: integer }

    ListingDetailResponse:
      allOf:
        - $ref: "#/components/schemas/SuccessResponse"
        - properties:
            data:
              type: object
              properties:
                id: { type: string }
                code: { type: string }
                title: { type: string }
                description: { type: string }
                images:
                  type: array
                  items:
                    type: object
                    properties:
                      url: { type: string }
                      sortOrder: { type: integer }
                agent:
                  type: object
                  properties:
                    name: { type: string }
                    phone: { type: string }
                    email: { type: string }

    NeighborhoodsResponse:
      type: object
      properties:
        success: { type: boolean }
        data:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              name: { type: string }
              slug: { type: string }
              listingCount: { type: integer }

    CreateViewingInput:
      type: object
      required: [listingId, name, phone, preferredDatetime, message]
      properties:
        listingId: { type: string }
        name: { type: string }
        phone: { type: string, example: "+256700123456" }
        preferredDatetime: { type: string, format: date-time }
        message: { type: string }

    CreateContactInput:
      type: object
      required: [name, phone, message]
      properties:
        name: { type: string }
        email: { type: string, format: email }
        phone: { type: string, example: "+256700123456" }
        message: { type: string }
        listingId: { type: string }

  responses:
    ValidationError:
      description: Validation failed
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
